---
title: "Preprocessing data from census tracts in the state of São Paulo, Brazil"
output: html_notebook
---

A dataset with information from census tracts in São Paulo State, Brazil. Data source:

- Fundação Sistema Estadual de Análise de Dados [SEADE]. (2013). Índice Paulista de Vulnerabilidade Social. SEADE. Retrieved May 8, 2024, from http://ipvs.seade.gov.br/
- Pereira, R.H.M.; Gonçalves, C.N.; et. all (2019) geobr: Loads Shapefiles of Official Spatial Data Sets of Brazil. GitHub repository - https://github.com/ipeaGIT/geobr.
- Pereira, R. H. M.; Barbosa, R. J. (2023) censobr: Download Data from Brazil's Population Census. R package version v0.2.0, <https://CRAN.R-project.org/package=censobr>.
 
Load libraries:
```{r load-libraries}
library(tidyr)
library(tidyverse)
library(dplyr)
library(geobr)
library(censobr)
```
Read the census tracts geometries (2010): 
```{r reading-census-tract}
cntr_sp <- read_census_tract(
  code_tract = "SP", 
  year = 2010,
  showProgress = TRUE,
  )
```

Selects specific columns from the census dataset:
```{r columns-ct}
cntr_sp <- cntr_sp %>%
  select(code_tract, zone, code_muni, name_muni, code_district, name_district,code_state,geom)
```

# IPVS

Reading data from the São Paulo Social Vulnerability Index (2013):
```{r ipvs-csv}
ipvs <- read.csv("baseIPVS2010.csv", sep=';',encoding="UTF-8") 
```

Selects specific columns from the IPVS dataset:
```{r columns-ipvs}
ipvs <- ipvs %>%
  select(v7,v9,v10,v11,v12,v13,v16,v19,v20,v21,v22,v23,v24,v25,v26,v27,v28,v29,v30,v40,v41,v42,v43)
```
Join the two datasets:
```{r join-tables}
cntr_sp_ipvs <- merge(ipvs, cntr_sp, by.x = "v7", by.y = "code_tract", all.x = TRUE) %>%
  mutate(v9 = case_when(v9 == "N" ~ "Não especial",
                        v9 == "S" ~ "Subnormal"),
          v10 = case_when(v10 == 0 ~ "Não classificado",
                        v10 == 1 ~ "Baixíssima vulnerabilidade", 
                        v10 == 2 ~	"Vulnerabilidade muito baixa",
                        v10 == 3	~ "Vulnerabilidade baixa",
                        v10 == 4	~ "Vulnerabilidade média",
                        v10 == 5	~ "Vulnerabilidade alta",
                        v10 == 6	~ "Vulnerabilidade muito alta",
                        v10 == 7	~ "Vulnerabilidade alta"), 
          v10 = factor(v10, levels = c("Não classificado", "Baixíssima vulnerabilidade","Vulnerabilidade muito baixa",
                                       "Vulnerabilidade baixa","Vulnerabilidade média",
                                       "Vulnerabilidade alta", "Vulnerabilidade muito alta"),
                            ordered=TRUE)) %>%
  mutate_at(c("v7", "zone", "code_muni", "name_muni", "code_district", "name_district","code_state", "v9"), as.factor)
```

Rename some columns in the new dataset:
```{r rename-tables}
colnames(cntr_sp_ipvs)[1:3] <- c("COD_SETOR","AGSN","IPVS")
```

# Census Dataset - Basico

Reading data from the census dataset (basic information on the census tracts):
```{r}
cntr_sp_basico <- read_tracts(
  year = 2010,
  dataset = "Basico",
  as_data_frame = TRUE,
  showProgress = TRUE,
  cache = TRUE
)
```
Filtering data from São Paulo state and adjusting the "Situação" variable:
```{r}
cntr_sp_basico <- cntr_sp_basico %>%
  filter(name_state == "São Paulo") %>%
  select(code_tract, Basico_V1005, V001, V002, V003, V004, V005) %>% 
  mutate(Basico_V1005 = case_when(Basico_V1005 == 1 ~ "Área urbanizada de cidade ou vila", 
                        Basico_V1005 == 2 ~	"Área não urbanizada de cidade ou vila",
                        Basico_V1005 == 3	~ "Área urbana isolada",
                        Basico_V1005 == 4	~ "Aglomerado rural de extensão urbana",
                        Basico_V1005 == 5	~ "Aglomerado rural isolado - povoado",
                        Basico_V1005 == 6	~ "Aglomerado rural isolado - núcleo",
                        Basico_V1005 == 7	~ "Aglomerado rural isolado - outros aglomerados",
                        Basico_V1005 == 8	~ "Zona rural, exclusive aglomerado rural")) %>%
  mutate_at(c("code_tract", "Basico_V1005"), as.factor)

colnames(cntr_sp_basico) <- c("code_tract", "situacao","b_V001", "b_V002", "b_V003", "b_V004", "b_V005")
```

# Census Dataset - Head of household

Reading data from the census dataset (Income of the head of household):

```{r}
cntr_sp_head <- read_tracts(
  year = 2010,
  dataset = "ResponsavelRenda",
  as_data_frame = TRUE,
  showProgress = TRUE,
  cache = TRUE
)

cntr_sp_head <- cntr_sp_head %>%
  filter(name_state == "São Paulo") %>%
  select(code_tract, V001, V002, V003, V004, V005, V006, V007, V008, V009, V010) %>% 
  mutate_at(c("code_tract"), as.factor)


colnames(cntr_sp_head) <- c("code_tract", "h_V001", "h_V002", "h_V003", "h_V004", "h_V005", "h_V006", "h_V007", "h_V008", "h_V009", "h_V010")
```

Save data:
```{r}
usethis::use_data(cntr_sp_ipvs, overwrite = TRUE)
```
```{r}
usethis::use_data(cntr_sp_basico, overwrite = TRUE)
```

```{r}
usethis::use_data(cntr_sp_head, overwrite = TRUE)
```

